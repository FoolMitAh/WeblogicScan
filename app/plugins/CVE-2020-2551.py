#!/usr/bin/env python
# _*_ coding:utf-8 _*_

import logging
import socket

from ..platform import ManageProcessor, Color

logging.basicConfig(filename='Weblogic.log',
                    format='%(asctime)s %(message)s',
                    filemode="w", level=logging.INFO)

VUL = 'CVE-2020-2551'


@ManageProcessor.plugin_register('CVE20202551')
class CVE20202551(object):
    def process(self, ip, port):
        self.run(ip, port)

    def poc(self, ip, port):
        sock = None
        data = bytes.fromhex('47494f50010200030000001700000002000000000000000b4e616d6553657276696365')
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(7)
            server_addr = (ip, int(port))
            sock.connect(server_addr)
            sock.send(data)
            res = sock.recv(1024)
            if b'GIOP' in res:
                return True
        except Exception as e:
            pass
        finally:
            if sock is not None:
                sock.close()
        return False

    def run(self, ip, port):
        if self.poc(ip, port):
            logging.info('[+]The target weblogic has a JAVA deserialization vulnerability:{}'.format(VUL))
            print(Color.OKBLUE+'[+]The target weblogic has a JAVA deserialization vulnerability:{}'.format(VUL)+Color.ENDC)
            print(Color.OKGREEN+'[+]CVE-2020-2551 漏洞存在'+Color.ENDC)
        else:
            logging.info('[-]Target weblogic not detected {}'.format(VUL))
            print(Color.FAIL+'[-]Target weblogic not detected {}'.format(VUL)+Color.ENDC)
